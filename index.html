
<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Infinity Tycoon ‚Äì V√°ros + Z√≥n√°k (Long‚ÄëTerm Balance)</title>
<style>
  :root{
    --city-w:12; --city-h:8; --tile:76px;
    --ui-bg:rgba(22,22,28,.92); --ui-fg:#fff;
    --grass1:#a7dba7; --grass2:#96d196; --road:#2a2a2f; --line:#e9e9ea;
  }
  html,body{height:100%;margin:0;background:#0f1420;color:#fff;
    font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",Arial,sans-serif;}

  /* √âg + h√°tt√©r sziluett */
  body::before{
    content:"";position:fixed;inset:0;z-index:-3;
    background:radial-gradient(1200px 500px at 80% -10%, #6fb1ff55, transparent 60%),
               linear-gradient(180deg,#6fb1ff,#e4f1ff 45%,#cfe6ff 70%);
  }
  body::after{
    content:"";position:fixed;left:0;right:0;bottom:0;height:38%;
    z-index:-2; opacity:.20;
    background:linear-gradient(180deg, #1b2130 0%, #0f1420 65%);
  }

  /* HUD / Men√º */
  #hud{position:fixed;left:12px;top:12px;z-index:6;background:var(--ui-bg);color:var(--ui-fg);
    padding:8px 12px;border-radius:12px;display:flex;gap:14px;align-items:center}
  #hud b{font-weight:700} .sep{opacity:.35}
  #menu{position:fixed;right:12px;top:12px;z-index:6;display:flex;gap:6px}
  .btn{padding:8px 10px;border:1px solid #454950;border-radius:10px;background:#0f1117;color:#fff;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  #rnd{position:fixed;right:12px;top:56px;z-index:6;background:var(--ui-bg);padding:10px;border-radius:12px;min-width:280px;display:none}
  #rnd h3{margin:.2rem 0 .4rem;font-size:14px}
  .upg-row{display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;margin:6px 0;padding:6px;border:1px solid #343a;border-radius:10px;background:#0e1118}

  /* V√°ros r√©tegek (pointer-events: none => nem blokkol klikket) */
  #city{position:fixed;inset:0;display:grid;place-items:center;z-index:1;}
  #city-wrap{position:relative}
  #ground{
    position:absolute; inset:0; z-index:0; pointer-events:none;
    background:radial-gradient(60% 80% at 20% 20%, rgba(255,255,255,.07), transparent 60%),
               linear-gradient(135deg, var(--grass1), var(--grass2));
    border-radius:24px; box-shadow:0 20px 60px rgba(0,0,0,.25);
  }
  #zones,#decor,#roads{position:absolute; inset:0; border-radius:24px; overflow:hidden; pointer-events:none}
  #zones{z-index:1} #decor{z-index:2} #roads{z-index:3}

  /* L√°thatatlan katt-r√©teg */
  #city-grid{position:relative; z-index:4; display:grid; gap:0;
    grid-template-columns:repeat(var(--city-w), var(--tile));
    grid-template-rows:repeat(var(--city-h), var(--tile));
    padding:0; border-radius:24px; background:transparent;
  }
  .tile{ width:var(--tile); height:var(--tile); position:relative; user-select:none; cursor:pointer; background:transparent; }
  .tile.sel{ outline:3px solid #4cc; outline-offset:-2px; }

  /* Rom √©s gy√°r */
  .ruin{position:absolute; inset:12%; border-radius:10px; background:linear-gradient(#3a3a3a,#1b1b1b);
    box-shadow: inset 0 -6px 0 rgba(255,255,255,.04), 0 6px 16px rgba(0,0,0,.35); opacity:.85; display:grid; place-items:center;}
  .ruin::before{content:"ROM"; font-weight:700; color:#ddd; background:#0008; padding:2px 8px; border-radius:999px;}
  .ruin.locked{filter:grayscale(.9) brightness(.75)}
  .ruin.locked::after{content:"Z√ÅROLVA"; position:absolute; bottom:6px; right:6px; font-size:11px; background:#222c; padding:2px 6px; border-radius:999px; color:#f6c;}

  .factory{position:absolute;inset:10%;border-radius:10px;padding:4px 6px;display:grid;align-content:end;gap:3px;pointer-events:none;background:linear-gradient(#333,#111);box-shadow:inset 0 -6px 0 rgba(255,255,255,.05),0 6px 16px rgba(0,0,0,.35)}
  .factory .roof{height:10px;border-radius:4px 4px 2px 2px;background:linear-gradient(#b33,#822);box-shadow:0 2px 0 rgba(0,0,0,.25)}
  .factory .body{background:
      linear-gradient(90deg, rgba(255,255,255,.06) 0 10%, transparent 10% 20%, rgba(255,255,255,.06) 20% 30%, transparent 30% 40%, rgba(255,255,255,.06) 40% 50%, transparent 50% 60%, rgba(255,255,255,.06) 60% 70%, transparent 70% 80%, rgba(255,255,255,.06) 80% 90%),
      linear-gradient(#2a2a2a,#151515); border-radius:6px;height:65%;position:relative}
  .factory .chimneys{position:absolute;left:6px;top:-12px;display:flex;gap:6px}
  .chimney{width:8px;height:18px;background:#666;border-radius:2px;position:relative}
  .chimney::after{content:"";position:absolute;left:50%;transform:translateX(-50%);top:-12px;width:10px;height:12px;border-radius:50%;
    background:radial-gradient(closest-side, rgba(255,255,255,.6), rgba(255,255,255,0));animation:smoke 1.8s infinite ease-in}
  @keyframes smoke{0%{transform:translate(-50%,0) scale(.7);opacity:.9}100%{transform:translate(-50%,-18px) scale(1.2);opacity:0}}
  .badge{position:absolute;right:6px;top:6px;background:#1a5;color:#fff;padding:2px 6px;border-radius:999px;font:12px/1.2 system-ui;box-shadow:0 1px 0 rgba(0,0,0,.4)}
  .badge.type{left:6px;right:auto;background:#2680eb}

  /* Akci√≥s√°v + extra gombok */
  #actions{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);display:flex;gap:8px;z-index:6;flex-wrap:wrap;justify-content:center}
  #actions .btn.main{background:#1a4;border-color:#083}
  #actions .btn.upg{background:#284;border-color:#173}
  #actions .btn.info{background:#333;border-color:#444}
  .qty{display:flex;gap:6px}
  .qty .btn{padding:6px 8px}

  /* Toast */
  #toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:8px 12px;border-radius:8px;font-size:14px;z-index:7;opacity:0;transition:opacity .2s}

  /* Z√≥na legenda */
  #zones-legend{position:fixed; right:12px; top:56px; z-index:6; background:var(--ui-bg); color:#fff; padding:10px 12px; border-radius:12px; display:none; min-width:260px}
  .zl-row{display:flex; align-items:center; gap:10px; margin:6px 0}
  .zl-swatch{width:16px;height:16px;border-radius:4px;box-shadow:0 0 0 2px rgba(255,255,255,.2) inset}

  @media (max-width:900px){ :root{--tile:62px} #hud{left:8px;top:8px} #menu{right:8px;top:8px} #rnd{right:8px;top:52px} #zones-legend{right:8px;top:52px} }
</style>
</head>
<body>
  <!-- HUD -->
  <div id="hud">
    üí∞ P√©nz: <b id="hud-money">0</b>
    <span class="sep">|</span>
    ‚öôÔ∏è Termel√©s: <b id="hud-ips">0 /s</b>
    <span class="sep">|</span>
    üèÖ Prestige: <b id="hud-prestige">0</b>
    <span class="sep">|</span>
    üìà √ñssz‚Äëbev√©tel: <b id="hud-gross">0</b>
  </div>

  <!-- Men√º -->
  <div id="menu">
    <button class="btn" id="btn-save"  title="Ment√©s">üíæ</button>
    <button class="btn" id="btn-load"  title="Bet√∂lt√©s">‚§æ</button>
    <button class="btn" id="btn-export" title="Export">‚§¥Ô∏é</button>
    <button class="btn" id="btn-import" title="Import">‚§µÔ∏é</button>
    <button class="btn" id="btn-pause" title="Sz√ºnet/Folytat√°s">‚èØ</button>
    <button class="btn" id="btn-reset" title="Reset">üóë</button>
    <button class="btn" id="btn-rnd"   title="R&D (fejleszt√©sek)">üß™ R&D</button>
    <button class="btn" id="btn-zones" title="Z√≥n√°k ki/be">üèô Z√≥n√°k</button>
  </div>

  <!-- R&D panel -->
  <div id="rnd"><h3>üß™ Kutat√°s & Fejleszt√©s</h3><div id="rnd-list"></div></div>
  <!-- Z√≥na legenda -->
  <div id="zones-legend"><b>V√°rosr√©szek</b><div id="zones-legend-list"></div></div>

  <!-- V√°ros -->
  <div id="city">
    <div id="city-wrap">
      <div id="ground"></div>
      <svg id="zones"></svg>
      <svg id="decor"></svg>
      <svg id="roads"></svg>
      <div id="city-grid" aria-label="V√°rosh√°l√≥"></div>
    </div>
  </div>

  <!-- Akci√≥k -->
  <div id="actions" hidden>
    <div class="qty">
      <button class="btn" id="qty-1">x1</button>
      <button class="btn" id="qty-10">x10</button>
      <button class="btn" id="qty-100">x100</button>
    </div>
    <button class="btn upg"  id="act-upg">Fejleszt√©s</button>
    <button class="btn main" id="act-reno">Renov√°l√°s</button>
    <button class="btn info" id="act-info">Inf√≥</button>
    <button class="btn"      id="act-tune" title="Finomhangol√°s ‚Äì kis b√≥nusz, id≈ëvel t√∂lt≈ëd≈ë">Tune</button>
    <span id="tune-info" style="align-self:center;opacity:.8"></span>
  </div>

  <div id="toast"></div>

<script>
/*** ==================== Hossz√∫ t√°v√∫ balansz + hibajav√≠t√°s ==================== ***/

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ T√≠pusok + Tech ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const TYPES = [
  { key:'workshop', name:'M≈±hely',   baseIPS:1.2,   lvMul:1.50,
    tech:[ {k:'tools',name:'Szersz√°mk√©szlet',base:1_000,scale:8,mult:2},
           {k:'auto', name:'Automata asztal',base:2_500,scale:10,mult:5},
           {k:'lean', name:'Lean folyamat',   base:5_000,scale:12,mult:10}, ]},
  { key:'foundry',  name:'√ñnt√∂de',   baseIPS:12,    lvMul:1.55,
    tech:[ {k:'heat', name:'H≈ëvisszanyer√©s', base:12_000,scale:9,mult:5},
           {k:'mold', name:'Gyors mint√°z√°s', base:30_000,scale:11,mult:20},
           {k:'bots', name:'√ñnvez. targonc√°k',base:60_000,scale:12,mult:100}, ]},
  { key:'bank',     name:'Bank',     baseIPS:120,   lvMul:1.60,
    tech:[ {k:'fra',  name:'Frakcion√°lt hozam',base:150_000,scale:9,mult:10},
           {k:'ai',   name:'AI kock√°zat',      base:400_000,scale:11,mult:50},
           {k:'defi', name:'DeFi integr√°ci√≥',  base:800_000,scale:12,mult:200}, ]},
  { key:'reactor',  name:'Reaktor',  baseIPS:1_000, lvMul:1.65,
    tech:[ {k:'fuel', name:'T√ºzel≈ëanyag ciklus',base:2e6,scale:9,mult:20},
           {k:'mag',  name:'M√°gneses pal√°st',   base:6e6,scale:11,mult:100},
           {k:'qpl',  name:'Kvantum plazma',    base:1.2e7,scale:12,mult:500}, ]},
  { key:'arc',      name:'Arkol√≥gia',baseIPS:8_000, lvMul:1.70,
    tech:[ {k:'swarm',name:'Dr√≥nraj',           base:5e7,scale:9,mult:50},
           {k:'syn',  name:'Szinergia-h√°l√≥',    base:1.6e8,scale:11,mult:300},
           {k:'meta', name:'Metagy√°r-protokoll',base:4e8,scale:12,mult:1500}, ]},
];

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ V√°rosr√©szek ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const ZONES = [
  { key:'old', name:'Belv√°ros',          color:'#3b82f6', rect:{x:0,y:0,w:4,h:3},
    ipsMul:1.10, upgMul:1.10, renoMul:1.10, typeBoost:{} },
  { key:'ind', name:'Ipari Park',        color:'#f59e0b', rect:{x:4,y:2,w:4,h:4},
    ipsMul:1.05, upgMul:0.90, renoMul:0.95, typeBoost:{0:1.15,1:1.15} },
  { key:'fin', name:'P√©nz√ºgyi Negyed',   color:'#10b981', rect:{x:8,y:1,w:4,h:3},
    ipsMul:1.00, upgMul:1.15, renoMul:1.15, typeBoost:{2:1.20} },
  { key:'eng', name:'Energia K√∂rzet',    color:'#ef4444', rect:{x:7,y:4,w:5,h:3},
    ipsMul:1.05, upgMul:1.10, renoMul:1.10, typeBoost:{3:1.25} },
  { key:'arc', name:'Arkol√≥gia Fenns√≠k', color:'#8b5cf6', rect:{x:9,y:0,w:3,h:2},
    ipsMul:1.10, upgMul:1.25, renoMul:1.30, typeBoost:{4:1.35} },
];

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Hossz√∫ t√°v√∫ pacing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   - Szegmensek: korai k√∂nny√≠t√©s -> k√∂z√©p/late fokoz√≥d√≥ k√∂lts√©g
   - √çgy sosem fut el, de mindig van mit fejleszteni
*/
const PACING = [
  { gross:     50_000, ips: 1.60, cost: 0.70 },
  { gross:    500_000, ips: 1.25, cost: 0.85 },
  { gross:  5_000_000, ips: 1.00, cost: 1.00 },
  { gross: 50_000_000, ips: 0.95, cost: 1.15 },
  { gross:500_000_000, ips: 0.90, cost: 1.30 },
  { gross:  5_000_000_000, ips: 0.85, cost: 1.50 },
  { gross: 50_000_000_000, ips: 0.80, cost: 1.75 },
  { gross:500_000_000_000, ips: 0.75, cost: 2.00 },
  { gross:               Infinity, ips: 0.70, cost: 2.30 }
];

/* Softcap a szorz√≥kra (tech*m√©rf√∂ldk≈ë stb.) ‚Äì kontroll√°lt g√∂rbe */
const SOFTCAP = { cap: 1e6, power: 0.60 };

/* Momentum (limit√°lt) */
const MOMENTUM_MAX = 0.30;   // +30%

/* Offline hozam limit (√≥r√°ban) */
const OFFLINE_CAP_HOURS = 8;

/* Romok & felold√°s ‚Äì lassabb, hossz√∫ t√°vra */
const UNLOCK_GROSS = [0,  200_000,   5_000_000,   150_000_000,  5_000_000_000];
const RENO_COST    = [200, 15_000,     350_000,     9_000_000,     220_000_000];

/* P√°lya */
const CITY_W = 12, CITY_H = 8;
const ROAD_ROWS = new Set([1,4,7]);
const ROAD_COLS = new Set([2,6,9]);

/* √Ållapot */
const state = {
  money:0, gross:0, prestige:0, paused:false, lastTick:Date.now(),
  city:{ w:CITY_W, h:CITY_H, factories:[], ruins:[] },
  tech:{},
  tune:{ charges:6, maxCharges:6, regenSec:180, lastRegen:Date.now() } // 1 charge / 3 perc, max 6
};

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Util ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const fmt = n => !isFinite(n) ? '‚àû' :
  (n<1e6 ? Math.floor(n).toLocaleString('hu-HU') :
  (()=>{const u=['','K','M','B','T','Qa','Qi','Sx','Sp','Oc','No','De'];let i=0;while(n>=1000&&i<u.length-1){n/=1000;i++;}return n.toFixed(2)+' '+u[i];})());
const isRoad = (x,y)=> ROAD_ROWS.has(y) || ROAD_COLS.has(x);
const zoneOf = (x,y)=>{ for(const z of ZONES){const r=z.rect; if(x>=r.x && x<r.x+r.w && y>=r.y && y<r.y+r.h) return z;} return null; };

function pacingNow(){
  for (const s of PACING) if (state.gross < s.gross) return s;
  return PACING[PACING.length-1];
}
function momentumMult(){
  const n = state.city.factories.length;
  return 1 + Math.min(0.03 * Math.max(0, n - 1), MOMENTUM_MAX);
}
function softcap(x, cap=SOFTCAP.cap, p=SOFTCAP.power){
  if (x <= cap) return x;
  return cap * Math.pow(x / cap, p);
}
function milestoneCount(f){ return Math.floor((f.level-1)/10); }
function milestoneMult(f){ return Math.pow(3, milestoneCount(f)); }
function milestoneCostMul(f){ return Math.pow(0.9, milestoneCount(f)); }

function techMultFor(typeKey){
  const tConf = TYPES.find(t=>t.key===typeKey), lvMap = state.tech[typeKey]||{};
  const raw = tConf.tech.reduce((m,t)=> m*Math.pow(t.mult, lvMap[t.k]||0), 1);
  return raw;
}

/* IPS (z√≥na + pace + momentum + softcap) */
function ipsForFactory(f){
  const conf = TYPES[f.type];
  const z = zoneOf(f.x, f.y);
  let mul = (1 + state.prestige*0.5);

  if (z){
    mul *= z.ipsMul || 1;
    if (z.typeBoost && z.typeBoost[f.type] != null) mul *= z.typeBoost[f.type];
  }

  // Tech + m√©rf√∂ldk≈ë -> softcap
  const growth = techMultFor(conf.key) * milestoneMult(f);
  mul *= softcap(growth);

  // Pacing + momentum
  const pc = pacingNow();
  mul *= pc.ips * momentumMult();

  return conf.baseIPS * Math.pow(conf.lvMul, f.level-1) * mul;
}
function totalIPS(){ return state.city.factories.reduce((s,f)=> s + ipsForFactory(f), 0); }

/* √År (z√≥na + pace + m√©rf√∂ldk≈ë kedvezm√©ny) + enyhe progress‚Äëinfl√°ci√≥ */
function progressInflation(){
  // G√∂rd√ºl≈ë infl√°ci√≥: min√©l nagyobb a gross, ann√°l er≈ësebb k√∂lts√©gszorz√≥
  // finom (0.04‚Äë0.12) k√∂zti kitev≈ë, hogy h√≥napokra ny√∫ljon
  const g = Math.max(1, state.gross);
  const era = Math.max(0, Math.log10(g / 1e6));   // 1e6 felett n≈ë
  return Math.pow(1.12, era);                     // 1.12^(era)
}
function levelUpCostSingle(f, nextLevel){
  const base   = 500 * Math.pow(1.30, nextLevel-1);      // kicsit er≈ësebb g√∂rbe
  const typeM  = Math.pow(7, f.type);                    // k√©s≈ëbbi t√≠pus dr√°g√°bb
  const z      = zoneOf(f.x, f.y);
  const zoneM  = z?.upgMul || 1;
  const pc     = pacingNow().cost;
  const mileM  = milestoneCostMul({level:nextLevel});    // kedvezm√©ny az eddigi milestone-ok alapj√°n
  const infl   = progressInflation();
  return Math.floor(base * typeM * zoneM * pc * (1/mileM) * infl);
}
/* Bulk v√°s√°rl√°s (x1/x10/x100) ‚Äì a single √°rakat √∂sszegezz√ºk */
function levelUpCostBulk(f, qty){
  let cost = 0;
  for (let i=1;i<=qty;i++){
    cost += levelUpCostSingle(f, f.level + i);
  }
  return cost;
}

/* Seed + ≈ërs√©g */
function seedCity(){
  state.city.factories.push({x:3,y:2,type:0,level:1, tune:0}); // tune: finomhangol√°s szint
  const ruins=[ {x:5,y:2,tier:1},{x:8,y:2,tier:2},{x:10,y:3,tier:3},
                {x:3,y:5,tier:1},{x:6,y:5,tier:2},{x:9,y:5,tier:3},{x:10,y:6,tier:4}]
               .filter(p=>!isRoad(p.x,p.y));
  state.city.ruins = ruins.map(p=>({x:p.x,y:p.y,tier:p.tier,unlocked:false}));
}
function ensureSeed(){
  if (!state.city.factories || state.city.factories.length===0){
    seedCity(); state.money=Math.max(state.money||0, 1500);
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ UI hivatkoz√°sok ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const grid      = document.getElementById('city-grid');
const wrap      = document.getElementById('city-wrap');
const svgZones  = document.getElementById('zones');
const svgDecor  = document.getElementById('decor');
const svgRoads  = document.getElementById('roads');
const elMoney   = document.getElementById('hud-money');
const elGross   = document.getElementById('hud-gross');
const elIPS     = document.getElementById('hud-ips');
const elPrest   = document.getElementById('hud-prestige');
const toastEl   = document.getElementById('toast');

const actions   = document.getElementById('actions');
const btnReno   = document.getElementById('act-reno');
const btnUpg    = document.getElementById('act-upg');
const btnInfo   = document.getElementById('act-info');
const btnTune   = document.getElementById('act-tune');
const tuneInfo  = document.getElementById('tune-info');

const btnSave   = document.getElementById('btn-save');
const btnLoad   = document.getElementById('btn-load');
const btnExport = document.getElementById('btn-export');
const btnImport = document.getElementById('btn-import');
const btnReset  = document.getElementById('btn-reset');
const btnPause  = document.getElementById('btn-pause');
const btnRnd    = document.getElementById('btn-rnd');
const rndPanel  = document.getElementById('rnd');
const rndList   = document.getElementById('rnd-list');

const btnZones  = document.getElementById('btn-zones');
const zlPanel   = document.getElementById('zones-legend');
const zlList    = document.getElementById('zones-legend-list');

const btnQ1=document.getElementById('qty-1'), btnQ10=document.getElementById('qty-10'), btnQ100=document.getElementById('qty-100');
let upgQty = 1;

let selected=null;

/* HUD/Toast */
function updateHUD(){ elMoney.textContent=fmt(state.money); elGross.textContent=fmt(state.gross); elIPS.textContent=fmt(totalIPS())+' /s'; elPrest.textContent=state.prestige; }
function toast(msg){ toastEl.textContent=msg; toastEl.style.opacity='1'; clearTimeout(toast._t); toast._t=setTimeout(()=>toastEl.style.opacity='0',1200); }

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Grid + R√©tegek ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildGrid(){
  grid.style.setProperty('--city-w', CITY_W);
  grid.style.setProperty('--city-h', CITY_H);
  grid.innerHTML='';
  for(let y=0;y<CITY_H;y++){
    for(let x=0;x<CITY_W;x++){
      const t=document.createElement('div');
      t.className='tile'; t.dataset.x=x; t.dataset.y=y;
      t.addEventListener('click', onTileClick);
      grid.appendChild(t);
    }
  }
  layoutLayers();
  renderAll();
}
function layoutLayers(){
  const tile = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--tile')) || 76;
  const w = CITY_W*tile, h = CITY_H*tile;
  wrap.style.width = w+'px'; wrap.style.height = h+'px';
  [svgZones, svgDecor, svgRoads].forEach(s=>{ s.setAttribute('viewBox', `0 0 ${w} ${h}`); s.setAttribute('width', w); s.setAttribute('height', h); });
  drawZones(w,h,tile); drawDecor(w,h,tile); drawRoads(w,h,tile);
}
function drawZones(w,h,t){
  svgZones.innerHTML='';
  const ns='http://www.w3.org/2000/svg';
  const group=document.createElementNS(ns,'g'); group.setAttribute('opacity','0.22'); svgZones.appendChild(group);
  ZONES.forEach(z=>{
    const rx = z.rect.x*t, ry = z.rect.y*t, rw = z.rect.w*t, rh = z.rect.h*t;
    const r=document.createElementNS(ns,'rect');
    r.setAttribute('x',rx); r.setAttribute('y',ry);
    r.setAttribute('width',rw); r.setAttribute('height',rh);
    r.setAttribute('fill',z.color); r.setAttribute('rx',12); r.setAttribute('ry',12);
    r.setAttribute('stroke',z.color); r.setAttribute('stroke-opacity','0.55'); r.setAttribute('stroke-width','2');
    r.setAttribute('fill-opacity','0.32');
    group.appendChild(r);

    const label=document.createElementNS(ns,'text');
    label.textContent=z.name;
    label.setAttribute('x', rx + rw/2); label.setAttribute('y', ry + 18);
    label.setAttribute('text-anchor','middle'); label.setAttribute('font-size','14'); label.setAttribute('fill','#fff'); label.setAttribute('opacity','0.9');
    svgZones.appendChild(label);
  });
  // legenda
  zlList.innerHTML='';
  ZONES.forEach(z=>{
    const row=document.createElement('div'); row.className='zl-row';
    const sw=document.createElement('div'); sw.className='zl-swatch'; sw.style.background=z.color; row.appendChild(sw);
    const txt=document.createElement('div'); txt.innerHTML = `<b>${z.name}</b><br/><small>IPS √ó${(z.ipsMul||1).toFixed(2)} ‚Ä¢ Szint √°r √ó${(z.upgMul||1).toFixed(2)} ‚Ä¢ Renov √°r √ó${(z.renoMul||1).toFixed(2)}</small>`;
    row.appendChild(txt); zlList.appendChild(row);
  });
}
function drawDecor(w,h,t){
  svgDecor.innerHTML='';
  const ns='http://www.w3.org/2000/svg';

  const river=document.createElementNS(ns,'path');
  river.setAttribute('d', `M ${-0.1*w} ${0.15*h} C ${0.2*w} ${0.05*h}, ${0.45*w} ${0.25*h}, ${0.7*w} ${0.18*h} S ${1.05*w} ${0.15*h}, ${1.1*w} ${0.3*h}`);
  river.setAttribute('fill','none'); river.setAttribute('stroke','#5fb6ff'); river.setAttribute('stroke-width', t*0.6);
  river.setAttribute('stroke-linecap','round'); river.setAttribute('stroke-opacity','0.35'); svgDecor.appendChild(river);

  const parks = [ {x:0.12*w,y:0.72*h, rx:0.18*w, ry:0.10*h}, {x:0.78*w,y:0.68*h, rx:0.14*w, ry:0.09*h}, {x:0.65*w,y:0.35*h, rx:0.10*w, ry:0.06*h} ];
  const defs=document.createElementNS(ns,'defs');
  const grad=document.createElementNS(ns,'radialGradient'); grad.id='parkGrad';
  const s1=document.createElementNS(ns,'stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','#7ecb7e');
  const s2=document.createElementNS(ns,'stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','#5daa5d');
  grad.appendChild(s1); grad.appendChild(s2); defs.appendChild(grad); svgDecor.appendChild(defs);
  parks.forEach(p=>{ const e=document.createElementNS(ns,'ellipse'); e.setAttribute('cx',p.x); e.setAttribute('cy',p.y); e.setAttribute('rx',p.rx); e.setAttribute('ry',p.ry); e.setAttribute('fill','url(#parkGrad)'); e.setAttribute('opacity','0.65'); svgDecor.appendChild(e); });

  for(let i=0;i<60;i++){
    const c=document.createElementNS(ns,'circle');
    const px=Math.random()*w, py=(0.55+Math.random()*0.4)*h;
    c.setAttribute('cx',px); c.setAttribute('cy',py);
    c.setAttribute('r',Math.random()*4+2);
    c.setAttribute('fill','#2f7d2f'); c.setAttribute('opacity','0.5');
    svgDecor.appendChild(c);
  }
}
function drawRoads(w,h,t){
  svgRoads.innerHTML='';
  const ns='http://www.w3.org/2000/svg';
  const thickness = t*0.62, lineW = Math.max(2, t*0.06);

  ROAD_ROWS.forEach(y=>{
    const yCenter = y*t + t*0.5;
    const r=document.createElementNS(ns,'rect');
    r.setAttribute('x',0); r.setAttribute('y',yCenter-thickness/2);
    r.setAttribute('width',w); r.setAttribute('height',thickness);
    r.setAttribute('fill','var(--road)'); svgRoads.appendChild(r);

    const mid=document.createElementNS(ns,'line');
    mid.setAttribute('x1',0); mid.setAttribute('y1',yCenter);
    mid.setAttribute('x2',w); mid.setAttribute('y2',yCenter);
    mid.setAttribute('stroke','var(--line)'); mid.setAttribute('stroke-width',lineW);
    mid.setAttribute('stroke-dasharray', `${t*0.35} ${t*0.25}`);
    mid.setAttribute('stroke-opacity','0.65');
    svgRoads.appendChild(mid);
  });
  ROAD_COLS.forEach(x=>{
    const xCenter = x*t + t*0.5;
    const r=document.createElementNS(ns,'rect');
    r.setAttribute('x',xCenter-thickness/2); r.setAttribute('y',0);
    r.setAttribute('width',thickness); r.setAttribute('height',h);
    r.setAttribute('fill','var(--road)'); svgRoads.appendChild(r);

    const mid=document.createElementNS(ns,'line');
    mid.setAttribute('x1',xCenter); mid.setAttribute('y1',0);
    mid.setAttribute('x2',xCenter); mid.setAttribute('y2',h);
    mid.setAttribute('stroke','var(--line)'); mid.setAttribute('stroke-width',lineW);
    mid.setAttribute('stroke-dasharray', `${t*0.35} ${t*0.25}`);
    mid.setAttribute('stroke-opacity','0.65');
    svgRoads.appendChild(mid);
  });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Render + Akci√≥s√°v ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function clearTiles(){ for(const t of grid.children){ t.querySelectorAll('.factory,.ruin').forEach(e=>e.remove()); t.classList.remove('sel'); } }
function factoryHTML(f){
  const conf = TYPES[f.type];
  const chimneys=Math.min(1+Math.floor((f.level-1)/2),4);
  const colorShift=Math.min(f.level-1,6);
  const roofGrad=`linear-gradient(#${['b33','b53','b73','b93','bb3','bd3','bf3'][colorShift]},#822)`;
  const bodyShade=Math.min(40+f.level*4,80);
  return `
    <div class="factory">
      <div class="badge type">${conf.name}</div>
      <div class="roof" style="background:${roofGrad}"></div>
      <div class="body" style="background:
        linear-gradient(90deg, rgba(255,255,255,.06) 0 10%, transparent 10% 20%, rgba(255,255,255,.06) 20% 30%, transparent 30% 40%, rgba(255,255,255,.06) 40% 50%, transparent 50% 60%, rgba(255,255,255,.06) 60% 70%, transparent 70% 80%, rgba(255,255,255,.06) 80% 90%),
        linear-gradient(#2a2a2a,#1${bodyShade}1${bodyShade})">
        <div class="chimneys">${'<div class="chimney"></div>'.repeat(chimneys)}</div>
      </div>
      <div class="badge">Lv ${f.level}</div>
    </div>`;
}
function ruinHTML(r){ return `<div class="ruin${r.unlocked?'':' locked'}"></div>`; }

function renderAll(){
  clearTiles();
  for(const r of state.city.ruins){
    const idx=r.y*CITY_W + r.x; const tile=grid.children[idx];
    if (tile) tile.insertAdjacentHTML('beforeend', ruinHTML(r));
  }
  for(const f of state.city.factories){
    const idx=f.y*CITY_W + f.x; const tile=grid.children[idx];
    if (tile) tile.insertAdjacentHTML('beforeend', factoryHTML(f));
  }
  if (selected){ const i=selected.y*CITY_W+selected.x; const t=grid.children[i]; if(t) t.classList.add('sel'); }
  updateHUD(); renderRND(); refreshActions();
}

/* Akci√≥s√°v friss√≠t√©s (minden frame-ben is h√≠vjuk) */
function refreshActions(){
  if(!selected){ actions.hidden=true; return; }
  const f=findFactoryAt(selected.x,selected.y);
  const r=findRuinAt(selected.x,selected.y);
  const z=zoneOf(selected.x,selected.y);

  actions.hidden = !(f||r);
  btnUpg.hidden=!f; btnReno.hidden=!r; btnInfo.hidden=!(f||r);
  btnTune.hidden=!f; tuneInfo.textContent='';

  if (f){
    // Bulk k√∂lts√©g
    const cost = levelUpCostBulk(f, upgQty);
    btnUpg.disabled = state.money < cost;
    btnUpg.textContent = `Fejleszt√©s +${upgQty} (${fmt(cost)})${z?` ‚Ä¢ ${z.name}`:''}`;

    // Tune st√°tusz
    tuneInfo.textContent = `Tune: ${state.tune.charges}/${state.tune.maxCharges}`;
    btnTune.disabled = state.tune.charges<=0;
  }
  if (r){
    const need=UNLOCK_GROSS[r.tier], base=RENO_COST[r.tier], zm=(z?.renoMul||1);
    const cost=Math.floor(base*zm*progressInflation());
    btnReno.disabled = !(r.unlocked && state.money >= cost);
    btnReno.textContent = r.unlocked ? `Renov√°l√°s (${fmt(cost)})${z?` ‚Ä¢ ${z.name}`:''}` : `Z√°rolt ‚Äì c√©l: ${fmt(need)} √∂ssz.`;
  }
}

/* Kijel√∂l√©s + akci√≥k */
function findFactoryAt(x,y){ return state.city.factories.find(f=>f.x===x && f.y===y); }
function findRuinAt(x,y){ return state.city.ruins.find(r=>r.x===x && r.y===y); }
function onTileClick(e){
  for(const t of grid.children) t.classList.remove('sel');
  const t=e.currentTarget; t.classList.add('sel');
  selected={x:+t.dataset.x,y:+t.dataset.y};
  refreshActions();
}

/* Bulk qty gombok */
btnQ1.onclick = ()=>{upgQty=1; toast('x1'); refreshActions();};
btnQ10.onclick= ()=>{upgQty=10;toast('x10');refreshActions();};
btnQ100.onclick=()=>{upgQty=100;toast('x100');refreshActions();};

/* Fejleszt√©s (bulk) */
btnUpg.onclick=()=>{
  if(!selected) return; const f=findFactoryAt(selected.x,selected.y); if(!f) return;
  const cost=levelUpCostBulk(f, upgQty); if(state.money<cost) return;
  state.money-=cost; f.level+=upgQty;
  if (f.level % 10 === 0) toast(`M√©rf√∂ldk≈ë! √ó3 termel√©s √©s ‚àí10% j√∂v≈ëbeli szint√°r (stackel).`);
  renderAll(); saveNow(false);
};
/* Renov√°l√°s */
btnReno.onclick=()=>{
  if(!selected) return; const r=findRuinAt(selected.x,selected.y); if(!r||!r.unlocked) return;
  const z=zoneOf(r.x,r.y);
  const cost=Math.floor(RENO_COST[r.tier]*(z?.renoMul||1)*progressInflation());
  if(state.money<cost) return;
  state.money-=cost;
  state.city.ruins=state.city.ruins.filter(x=>!(x.x===r.x&&x.y===r.y));
  state.city.factories.push({x:r.x,y:r.y,type:r.tier,level:1,tune:0});
  renderAll(); saveNow(false); toast('Renov√°lva');
};
/* Inf√≥ */
btnInfo.onclick=()=>{
  if(!selected) return; const f=findFactoryAt(selected.x,selected.y), r=findRuinAt(selected.x,selected.y); const z=zoneOf(selected.x, selected.y);
  if(f){ const conf=TYPES[f.type];
    alert(`${conf.name}\nZ√≥na: ${z?z.name:'N/A'}\nSzint: ${f.level}\nTune: ${f.tune||0} (√ó${(1+0.01*(f.tune||0)).toFixed(2)})\nM√©rf√∂ldk√∂vek: ${milestoneCount(f)} (√ó${milestoneMult(f).toFixed(0)} saj√°t IPS)\nTermel√©s: ${ipsForFactory(f).toFixed(2)} /s\nK√∂vetkez≈ë(ek) √°ra: ${fmt(levelUpCostBulk(f, upgQty))}`);
  } else if(r){ const name=TYPES[r.tier].name; const base=RENO_COST[r.tier], zm=(z?.renoMul||1);
    alert(`Rom (${name})\nZ√≥na: ${z?z.name:'N/A'}\nFelold√°s: √∂ssz‚Äëbev√©tel ‚â• ${fmt(UNLOCK_GROSS[r.tier])}\nRenov√°l√°s √°ra: ${fmt(base*zm*progressInflation())}`);
  }
};

/* Finomhangol√°s (Tune): kis b√≥nusz √ó1%/charge gy√°ronk√©nt, max 100 stack/gy√°r
   - charge visszat√∂lt 1/3 perc; glob√°lis k√©szletb≈ël k√∂lt
*/
btnTune.onclick=()=>{
  if(!selected) return; const f=findFactoryAt(selected.x,selected.y); if(!f) return;
  if (state.tune.charges<=0) return;
  f.tune = Math.min(100, (f.tune||0) + 1);
  state.tune.charges -= 1;
  toast(`Tune +1% ‚Üí ${f.tune}%`);
  renderAll(); saveNow(false);
};
/* Tune hat√°s hozz√°ad√°sa az IPS-hez (szorz√≥) */
const _ipsRaw = ipsForFactory;
ipsForFactory = function(f){
  const base = _ipsRaw(f);
  const tuneMul = 1 + 0.01 * (f.tune||0);
  return base * tuneMul;
}

/* Charge regen */
function regenTune(){
  const now = Date.now();
  const dt = Math.floor((now - state.tune.lastRegen)/1000);
  if (dt >= state.tune.regenSec){
    const add = Math.floor(dt / state.tune.regenSec);
    state.tune.charges = Math.min(state.tune.maxCharges, state.tune.charges + add);
    state.tune.lastRegen = now - (dt % state.tune.regenSec)*1000;
  }
}

/* Felold√°s gross alapj√°n */
function checkUnlocks(){
  for(const r of state.city.ruins){
    if(!r.unlocked && state.gross>=UNLOCK_GROSS[r.tier]){
      r.unlocked=true;
      const idx=r.y*CITY_W+r.x, tile=grid.children[idx];
      if(tile){ const el=tile.querySelector('.ruin'); if(el) el.classList.remove('locked'); }
      toast(`${TYPES[r.tier].name} feloldva ‚Äî renov√°lhat√≥!`);
    }
  }
}

/* R&D */
function techLevel(typeKey,k){ return (state.tech[typeKey]?.[k]||0); }
function techCost(typeKey,k){
  const conf=TYPES.find(t=>t.key===typeKey), t=conf.tech.find(x=>x.k===k), lv=techLevel(typeKey,k);
  // R&D k√∂lts√©gek is kapnak progress infl√°ci√≥t
  return Math.floor(t.base*Math.pow(t.scale,lv)*progressInflation());
}
function buyTech(typeKey,k){
  const cost=techCost(typeKey,k);
  if(state.money<cost) return;
  state.money-=cost; state.tech[typeKey]=state.tech[typeKey]||{};
  state.tech[typeKey][k]=techLevel(typeKey,k)+1;
  renderAll(); saveNow(false); toast('Tech megv√©ve');
}
function hasAnyFactoryOfType(idx){ return state.city.factories.some(f=>f.type===idx); }
function renderRND(){
  const open=rndPanel.style.display!=='none'; if(!open) return;
  rndList.innerHTML='';
  TYPES.forEach((t,idx)=>{
    const enabled=hasAnyFactoryOfType(idx)||state.city.ruins.some(r=>r.tier===idx&&r.unlocked);
    if(!enabled) return;
    const h=document.createElement('div'); h.innerHTML=`<h3>${t.name} ‚Äì Tech</h3>`; rndList.appendChild(h);
    t.tech.forEach(tech=>{
      const row=document.createElement('div'); row.className='upg-row';
      const lv=techLevel(t.key,tech.k), cost=techCost(t.key,tech.k);
      row.innerHTML=`
        <div><b>${tech.name}</b><br/><small>Szint: ${lv} ‚Ä¢ Szorz√≥: √ó${tech.mult}/szint</small></div>
        <button class="btn" ${state.money<cost?'disabled':''}>V√©tel (${fmt(cost)})</button>`;
      row.querySelector('button').onclick=()=>buyTech(t.key,tech.k);
      rndList.appendChild(row);
    });
  });
}

/* Z√≥n√°k ki/be + legenda */
document.getElementById('btn-zones').onclick=()=>{
  const show=svgZones.style.display==='none';
  svgZones.style.display=show?'block':'none';
  zlPanel.style.display=show?'block':'none';
};
(function initLegend(){ svgZones.style.display='block'; zlPanel.style.display='block'; })();

/* Ment√©s/Bet√∂lt√©s/Offline */
const SAVE_KEY='infty-city-zones-v5';
function gameGetState(){ return {v:8, money:state.money, gross:state.gross, prestige:state.prestige, paused:state.paused, city:state.city, tech:state.tech, tune:state.tune, lastTick:Date.now()}; }
function gameSetState(s){
  if(!s) return;
  state.money=+s.money||0; state.gross=+s.gross||0; state.prestige=+s.prestige||0; state.paused=!!s.paused;
  if(s.city){
    state.city.factories=(s.city.factories||[]).map(f=>({x:f.x,y:f.y,type:f.type,level:f.level,tune:f.tune||0}));
    state.city.ruins=(s.city.ruins||[]).map(r=>({x:r.x,y:r.y,tier:r.tier,unlocked:!!r.unlocked}));
  }
  state.tech=s.tech||{};
  state.tune = Object.assign({charges:6,maxCharges:6,regenSec:180,lastRegen:Date.now()}, s.tune||{});
}
function gameApplyOffline(ms){
  const capMs = Math.min(ms, OFFLINE_CAP_HOURS*3600*1000);
  const gain = totalIPS() * (capMs/1000);
  state.money += gain; state.gross += gain;
}

/* Loop ‚Äì minden frame: p√©nz, unlock, action refresh, tune regen */
let _last=performance.now();
function loop(){
  const now=performance.now(), dt=(now-_last)/1000; _last=now;
  if(!state.paused){
    regenTune();
    const inc=totalIPS()*dt;
    state.money+=inc; state.gross+=inc;
    checkUnlocks();
  }
  updateHUD(); refreshActions();
  requestAnimationFrame(loop);
}

/* Init */
function init(){
  const raw=localStorage.getItem(SAVE_KEY);
  if(raw){
    try{
      const s=JSON.parse(raw); gameSetState(s);
      const dt=Date.now()-(s.lastTick||Date.now()); if(dt>5000) gameApplyOffline(dt);
      ensureSeed();
    }catch{ seedCity(); state.money=1500; }
  }else{
    seedCity(); state.money=1500;
  }
  buildGrid(); updateHUD();
  setInterval(()=>{ localStorage.setItem(SAVE_KEY, JSON.stringify(gameGetState())); }, 10_000);
  requestAnimationFrame(loop);
}

/* Men√º */
btnSave.onclick  = ()=>{ localStorage.setItem(SAVE_KEY, JSON.stringify(gameGetState())); toast('Mentve'); };
btnLoad.onclick  = ()=>{ const raw=localStorage.getItem(SAVE_KEY); if(!raw) return toast('Nincs ment√©s'); const s=JSON.parse(raw); gameSetState(s); ensureSeed(); renderAll(); toast('Bet√∂ltve'); };
btnExport.onclick= ()=>{ try{ const b64=btoa(localStorage.getItem(SAVE_KEY)||''); navigator.clipboard?.writeText(b64); prompt('M√°sold ki a ment√©st:', b64);}catch{toast('Export hiba');}};
btnImport.onclick= ()=>{ const b64=prompt('Illeszd be az export√°lt ment√©st:'); if(!b64) return; try{ const raw=atob(b64); localStorage.setItem(SAVE_KEY, raw); const s=JSON.parse(raw); gameSetState(s); ensureSeed(); renderAll(); toast('Import OK'); }catch{ toast('Import hiba'); } };
btnReset.onclick = ()=>{ if(!confirm('Biztos?')) return; localStorage.removeItem(SAVE_KEY); location.reload(); };
btnPause.onclick = ()=>{ state.paused=!state.paused; toast(state.paused?'Sz√ºnet':'Folytat√°s'); };
btnRnd.onclick   = ()=>{ const show=rndPanel.style.display!=='block'; rndPanel.style.display=show?'block':'none'; renderRND(); };

init();
</script>
</body>
</html>
