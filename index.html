
<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Infinity Tycoon ‚Äì V√°ros</title>
<style>
  :root{
    --city-w: 12; --city-h: 8; --tile: 76px;
    --ui-bg: rgba(22,22,28,.92); --ui-fg:#fff;
    --road:#2a2a2f; --line:#e9e9ea; --grass1:#a7dba7; --grass2:#96d196;
  }
  html,body{height:100%;margin:0;background:#0f1420;color:#fff;
    font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",Arial,sans-serif;}
  /* Sima v√°ros h√°tterek (sziluettek) */
  body::before{
    content:"";position:fixed;inset:0;z-index:-3;
    background:
      radial-gradient(1200px 500px at 80% -10%, #6fb1ff55, transparent 60%),
      linear-gradient(180deg,#6fb1ff,#e4f1ff 45%,#cfe6ff 70%);
  }
  body::after{
    content:"";position:fixed;left:0;right:0;bottom:0;height:40%;
    z-index:-2; opacity:.22;
    background:
      linear-gradient( to right,
        transparent 0 5%, #222 5% 6%, transparent 6% 9%, #222 9% 10%, transparent 10% 15%,
        #222 15% 16%, transparent 16% 18%, #222 18% 19%, transparent 19% 23%, #222 23% 24%, transparent 24% 29%,
        #222 29% 30%, transparent 30% 33%, #222 33% 34%, transparent 34% 38%, #222 38% 39%, transparent 39% 45%
      ),
      linear-gradient(180deg, #1b2130 0%, #0f1420 65%);
  }

  /* HUD */
  #hud{position:fixed;left:12px;top:12px;z-index:5;background:var(--ui-bg);color:var(--ui-fg);
    padding:8px 12px;border-radius:12px;display:flex;gap:14px;align-items:center}
  #hud b{font-weight:700} .sep{opacity:.35}

  /* Men√º + R&D */
  #menu{position:fixed;right:12px;top:12px;z-index:5;display:flex;gap:6px}
  .btn{padding:8px 10px;border:1px solid #454950;border-radius:10px;background:#0f1117;color:#fff;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  #rnd{position:fixed;right:12px;top:56px;z-index:5;background:var(--ui-bg);padding:10px;border-radius:12px;min-width:280px;display:none}
  #rnd h3{margin:.2rem 0 .4rem;font-size:14px}
  .upg-row{display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;margin:6px 0;padding:6px;border:1px solid #343a; border-radius:10px;background:#0e1118}

  /* City grid ‚Äì letisztult burkolt utak + z√∂ld */
  #city{position:fixed;inset:0;display:grid;place-items:center;z-index:1;}
  #city-grid{
    display:grid;
    grid-template-columns:repeat(var(--city-w), var(--tile));
    grid-template-rows:repeat(var(--city-h), var(--tile));
    gap:8px;padding:14px;border-radius:22px;background:rgba(255,255,255,.35);
    box-shadow:0 20px 60px rgba(0,0,0,.25);backdrop-filter: blur(8px);
  }
  .tile{width:var(--tile);height:var(--tile);position:relative;border-radius:16px;overflow:hidden;user-select:none;cursor:pointer}
  .lot{
    background:
      radial-gradient(18% 18% at 20% 30%, rgba(0,0,0,.08), transparent 60%),
      linear-gradient(135deg, var(--grass1), var(--grass2));
    box-shadow: inset 0 0 0 2px rgba(8,8,8,.07);
  }
  .road{
    background:
      linear-gradient(90deg, transparent 48%, var(--line) 48% 52%, transparent 52%),
      var(--road);
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.04);
  }
  .road.cross::after{
    content:""; position:absolute; inset:12% 12%;
    background:
      repeating-linear-gradient(90deg, var(--line) 0 8px, transparent 8px 16px),
      repeating-linear-gradient(0deg,  var(--line) 0 8px, transparent 8px 16px);
    opacity:.16; mix-blend-mode:screen;
  }
  .tile.sel{outline:3px solid #4cc}

  /* Ruin (rom) vizu√°l */
  .ruin{
    position:absolute; inset:10%; border-radius:10px; background:linear-gradient(#3a3a3a,#1b1b1b); 
    box-shadow: inset 0 -6px 0 rgba(255,255,255,.04), 0 6px 16px rgba(0,0,0,.35);
    opacity:.8; display:grid; place-items:center;
  }
  .ruin::before{
    content:"ROM"; font-weight:700; color:#ddd; background:#0008; padding:2px 8px; border-radius:999px;
  }
  .ruin.locked{filter:grayscale(0.9) brightness(0.7)}
  .ruin.locked::after{
    content:"Z√ÅROLVA"; position:absolute; bottom:6px; right:6px; font-size:11px; 
    background:#222c; padding:2px 6px; border-radius:999px; color:#f6c;
  }

  /* Factory vizu√°l (szinttel egyre ‚Äûmen≈ëbb‚Äù) */
  .factory{position:absolute;inset:10%;border-radius:10px;padding:4px 6px;display:grid;align-content:end;gap:3px;pointer-events:none;background:linear-gradient(#333,#111);box-shadow:inset 0 -6px 0 rgba(255,255,255,.05),0 6px 16px rgba(0,0,0,.35)}
  .factory .roof{height:10px;border-radius:4px 4px 2px 2px;background:linear-gradient(#b33,#822);box-shadow:0 2px 0 rgba(0,0,0,.25)}
  .factory .body{background:
      linear-gradient(90deg, rgba(255,255,255,.06) 0 10%, transparent 10% 20%, rgba(255,255,255,.06) 20% 30%, transparent 30% 40%, rgba(255,255,255,.06) 40% 50%, transparent 50% 60%, rgba(255,255,255,.06) 60% 70%, transparent 70% 80%, rgba(255,255,255,.06) 80% 90%),
      linear-gradient(#2a2a2a,#151515); border-radius:6px;height:65%;position:relative}
  .factory .chimneys{position:absolute;left:6px;top:-12px;display:flex;gap:6px}
  .chimney{width:8px;height:18px;background:#666;border-radius:2px;position:relative}
  .chimney::after{content:"";position:absolute;left:50%;transform:translateX(-50%);top:-12px;width:10px;height:12px;border-radius:50%;
    background:radial-gradient(closest-side, rgba(255,255,255,.6), rgba(255,255,255,0));animation:smoke 1.8s infinite ease-in}
  @keyframes smoke{0%{transform:translate(-50%,0) scale(.7);opacity:.9}100%{transform:translate(-50%,-18px) scale(1.2);opacity:0}}
  .badge{position:absolute;right:6px;top:6px;background:#1a5;color:#fff;padding:2px 6px;border-radius:999px;font:12px/1.2 system-ui;box-shadow:0 1px 0 rgba(0,0,0,.4)}
  .badge.type{left:6px;right:auto;background:#2680eb}

  /* Akci√≥s√°v */
  #actions{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);display:flex;gap:8px;z-index:5}
  #actions .btn.main{background:#1a4;border-color:#083}
  #actions .btn.upg{background:#284;border-color:#173}
  #actions .btn.info{background:#333;border-color:#444}

  /* Toast */
  #toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:8px 12px;border-radius:8px;font-size:14px;z-index:6;opacity:0;transition:opacity .2s}

  @media (max-width:900px){ :root{--tile:62px} #hud{left:8px;top:8px} #menu{right:8px;top:8px} #rnd{right:8px;top:52px} }
</style>
</head>
<body>
  <!-- HUD -->
  <div id="hud">
    üí∞ P√©nz: <b id="hud-money">0</b>
    <span class="sep">|</span>
    ‚öôÔ∏è Termel√©s: <b id="hud-ips">0 /s</b>
    <span class="sep">|</span>
    üèÖ Prestige: <b id="hud-prestige">0</b>
    <span class="sep">|</span>
    üìà √ñssz‚Äëbev√©tel: <b id="hud-gross">0</b>
  </div>

  <!-- Men√º -->
  <div id="menu">
    <button class="btn" id="btn-save"  title="Ment√©s">üíæ</button>
    <button class="btn" id="btn-load"  title="Bet√∂lt√©s">‚§æ</button>
    <button class="btn" id="btn-export" title="Export">‚§¥Ô∏é</button>
    <button class="btn" id="btn-import" title="Import">‚§µÔ∏é</button>
    <button class="btn" id="btn-pause" title="Sz√ºnet/Folytat√°s">‚èØ</button>
    <button class="btn" id="btn-reset" title="Reset">üóë</button>
    <button class="btn" id="btn-rnd"   title="R&D (fejleszt√©sek)">üß™ R&D</button>
  </div>

  <!-- R&D panel -->
  <div id="rnd">
    <h3>üß™ Kutat√°s & Fejleszt√©s</h3>
    <div id="rnd-list"></div>
  </div>

  <!-- City -->
  <div id="city"><div id="city-grid" aria-label="V√°rosh√°l√≥"></div></div>

  <!-- Akci√≥k -->
  <div id="actions" hidden>
    <button class="btn main" id="act-reno">Renov√°l√°s</button>
    <button class="btn upg"  id="act-upg">Fejleszt√©s (szint)</button>
    <button class="btn info" id="act-info">Inf√≥</button>
  </div>

  <div id="toast"></div>

<script>
/*** ================ J√ÅT√âKMAG ================= ***/

/* --------- Gy√°r-t√≠pusok (k√©s≈ëbbi t√≠pus: OP-ebb tech) --------- */
const TYPES = [
  { key:'workshop', name:'M≈±hely',   baseIPS:1.2,   lvMul:1.50,
    tech:[ // name, base cost, scale, multiplier per level
      {k:'tools', name:'Szersz√°mk√©szlet', base:1_000,  scale:8,  mult:2},
      {k:'auto',  name:'Automata asztal', base:2_500,  scale:10, mult:5},
      {k:'lean',  name:'Lean folyamat',   base:5_000,  scale:12, mult:10},
    ]},
  { key:'foundry', name:'√ñnt√∂de',   baseIPS:12,    lvMul:1.55,
    tech:[
      {k:'heat',  name:'H≈ëvisszanyer√©s', base:12_000, scale:9,  mult:5},
      {k:'mold',  name:'Gyors mint√°z√°s', base:30_000, scale:11, mult:20},
      {k:'bots',  name:'√ñnvez. targonc√°k', base:60_000, scale:12, mult:100},
    ]},
  { key:'bank',    name:'Bank',     baseIPS:120,   lvMul:1.60,
    tech:[
      {k:'fra',   name:'Frakcion√°lt hozam', base:150_000, scale:9,  mult:10},
      {k:'ai',    name:'AI kock√°zatkezel√©s', base:400_000, scale:11, mult:50},
      {k:'defi',  name:'DeFi integr√°ci√≥',    base:800_000, scale:12, mult:200},
    ]},
  { key:'reactor', name:'Reaktor',  baseIPS:1_000, lvMul:1.65,
    tech:[
      {k:'fuel',  name:'T√ºzel≈ëanyag ciklus', base:2_0e6, scale:9,  mult:20},
      {k:'mag',   name:'M√°gneses pal√°st',    base:6_0e6, scale:11, mult:100},
      {k:'qpl',   name:'Kvantum plazma el.', base:1.2e7, scale:12, mult:500},
    ]},
  { key:'arc',     name:'Arkol√≥gia',baseIPS:8_000, lvMul:1.70,
    tech:[
      {k:'swarm', name:'Dr√≥nraj',            base:5e7,   scale:9,  mult:50},
      {k:'syn',   name:'Szinergia-h√°l√≥',     base:1.6e8, scale:11, mult:300},
      {k:'meta',  name:'Metagy√°r-protokoll', base:4e8,   scale:12, mult:1500},
    ]},
];

/* --------- Felold√°si k√ºsz√∂b√∂k √©s renov √°rak t√≠pusonk√©nt --------- */
const UNLOCK_GROSS = [0, 5_000, 80_000, 1_200_000, 18_000_000];
const RENO_COST    = [ 500,   6_000,  90_000,  1_300_000, 20_000_000 ];

/* --------- P√°lya: utak --------- */
const CITY_W = 12, CITY_H = 8;
const ROAD_ROWS = new Set([1, 4, 7]);
const ROAD_COLS = new Set([2, 6, 9]);

/* --------- √Ållapot --------- */
const state = {
  money: 0,
  gross: 0,          // √∂sszes szerzett p√©nz (progress-hez)
  prestige: 0,
  paused: false,
  city: { w: CITY_W, h: CITY_H, factories: [], ruins: [] }, // factories: {x,y,type,level}, ruins:{x,y,tier,unlocked}
  tech: {},          // pl. tech['workshop']={tools:lv,auto:lv,...}
  lastTick: Date.now()
};

/* --------- Form√°z√≥ --------- */
const fmt = n => !isFinite(n) ? '‚àû' :
  (n<1e6 ? Math.floor(n).toLocaleString('hu-HU') :
  (()=>{const u=['','K','M','B','T','Qa','Qi','Sx','Sp','Oc','No','De'];let i=0;while(n>=1000&&i<u.length-1){n/=1000;i++;}return n.toFixed(2)+' '+u[i];})());
const isRoad = (x,y)=> ROAD_ROWS.has(y) || ROAD_COLS.has(x);

/* --------- IPS sz√°m√≠t√°s --------- */
function techMultFor(typeKey){
  const tConf = TYPES.find(t=>t.key===typeKey);
  const lvMap = state.tech[typeKey]||{};
  return tConf.tech.reduce((m,t)=> m*Math.pow(t.mult, lvMap[t.k]||0), 1);
}
function ipsForFactory(f){
  const conf = TYPES[f.type];
  return conf.baseIPS * Math.pow(conf.lvMul, f.level-1) * techMultFor(conf.key) * (1 + state.prestige*0.5);
}
function totalIPS(){ return state.city.factories.reduce((s,f)=> s + ipsForFactory(f), 0); }

/* --------- Seed: indulj 1 M≈±hellyel + k√∂r√ºl√∂tte romok --------- */
function seedCity(){
  const lots = [];
  for(let y=0;y<CITY_H;y++) for(let x=0;x<CITY_W;x++) if(!isRoad(x,y)) lots.push({x,y});
  // kezd≈ë gy√°r (k√∂z√©pt√°j)
  const start = {x:3,y:2}; // √ºgyelve: ne √∫t
  state.city.factories.push({x:start.x,y:start.y,type:0,level:1}); // M≈±hely L1

  // Kijel√∂lt rom helyek, n√∂vekv≈ë tierrel
  const ruinSpots = [
    {x:5,y:2,tier:1},{x:8,y:2,tier:2},{x:10,y:3,tier:3},
    {x:3,y:5,tier:1},{x:6,y:5,tier:2},{x:9,y:5,tier:3},{x:10,y:6,tier:4}
  ].filter(p=>!isRoad(p.x,p.y));
  state.city.ruins = ruinSpots.map(p=>({x:p.x,y:p.y,tier:p.tier,unlocked:false}));
}

/* --------- UI elemek --------- */
const grid      = document.getElementById('city-grid');
const elMoney   = document.getElementById('hud-money');
const elGross   = document.getElementById('hud-gross');
const elIPS     = document.getElementById('hud-ips');
const elPrest   = document.getElementById('hud-prestige');
const toastEl   = document.getElementById('toast');

const actions   = document.getElementById('actions');
const btnReno   = document.getElementById('act-reno');
const btnUpg    = document.getElementById('act-upg');
const btnInfo   = document.getElementById('act-info');

const btnSave   = document.getElementById('btn-save');
const btnLoad   = document.getElementById('btn-load');
const btnExport = document.getElementById('btn-export');
const btnImport = document.getElementById('btn-import');
const btnReset  = document.getElementById('btn-reset');
const btnPause  = document.getElementById('btn-pause');
const btnRnd    = document.getElementById('btn-rnd');
const rndPanel  = document.getElementById('rnd');
const rndList   = document.getElementById('rnd-list');

let selected = null;

/* --------- HUD/Toast --------- */
function updateHUD(){
  elMoney.textContent = fmt(state.money);
  elGross.textContent = fmt(state.gross);
  elIPS.textContent   = fmt(totalIPS())+' /s';
  elPrest.textContent = state.prestige;
}
function toast(msg){ toastEl.textContent=msg; toastEl.style.opacity='1'; clearTimeout(toast._t); toast._t=setTimeout(()=>toastEl.style.opacity='0',1200); }

/* --------- Grid √©p√≠t√©s --------- */
function buildGrid(){
  grid.style.setProperty('--city-w', CITY_W);
  grid.style.setProperty('--city-h', CITY_H);
  grid.innerHTML = '';
  for(let y=0;y<CITY_H;y++){
    for(let x=0;x<CITY_W;x++){
      const t = document.createElement('div');
      t.className = 'tile ' + (isRoad(x,y)?'road':'lot');
      if (isRoad(x,y) && ROAD_ROWS.has(y) && ROAD_COLS.has(x)) t.classList.add('cross');
      t.dataset.x = x; t.dataset.y = y;
      t.addEventListener('click', onTileClick);
      grid.appendChild(t);
    }
  }
  renderAll();
}

/* --------- Render: gy√°r + rom --------- */
function clearContent(){ for(const t of grid.children){ t.querySelectorAll('.factory,.ruin').forEach(e=>e.remove()); t.classList.remove('sel'); } }
function factoryHTML(f){
  const conf = TYPES[f.type];
  const chimneys = Math.min(1+Math.floor((f.level-1)/2),4);
  const colorShift = Math.min(f.level-1,6);
  const roofGrad = `linear-gradient(#${['b33','b53','b73','b93','bb3','bd3','bf3'][colorShift]},#822)`;
  const bodyShade = Math.min(40 + f.level*4, 80);
  const typeBadge = `<div class="badge type">${conf.name}</div>`;
  return `
    <div class="factory">
      ${typeBadge}
      <div class="roof" style="background:${roofGrad}"></div>
      <div class="body" style="background:
        linear-gradient(90deg, rgba(255,255,255,.06) 0 10%, transparent 10% 20%, rgba(255,255,255,.06) 20% 30%, transparent 30% 40%, rgba(255,255,255,.06) 40% 50%, transparent 50% 60%, rgba(255,255,255,.06) 60% 70%, transparent 70% 80%, rgba(255,255,255,.06) 80% 90%),
        linear-gradient(#2a2a2a,#1${bodyShade}1${bodyShade})">
        <div class="chimneys">${'<div class="chimney"></div>'.repeat(chimneys)}</div>
      </div>
      <div class="badge">Lv ${f.level}</div>
    </div>`;
}
function ruinHTML(r){
  const cls = 'ruin' + (r.unlocked?'':' locked');
  return `<div class="${cls}"></div>`;
}
function renderAll(){
  clearContent();
  // romok
  for(const r of state.city.ruins){
    const idx = r.y*CITY_W + r.x; const tile = grid.children[idx];
    if (tile) tile.insertAdjacentHTML('beforeend', ruinHTML(r));
  }
  // gy√°rak
  for(const f of state.city.factories){
    const idx = f.y*CITY_W + f.x; const tile = grid.children[idx];
    if (tile) tile.insertAdjacentHTML('beforeend', factoryHTML(f));
  }
  updateHUD();
  renderRND();
}

/* --------- Kijel√∂l√©s + akci√≥k --------- */
function findFactoryAt(x,y){ return state.city.factories.find(f=>f.x===x && f.y===y); }
function findRuinAt(x,y){ return state.city.ruins.find(r=>r.x===x && r.y===y); }

function onTileClick(e){
  for(const t of grid.children) t.classList.remove('sel');
  const t = e.currentTarget; t.classList.add('sel');
  selected = { x:+t.dataset.x, y:+t.dataset.y };
  const f = findFactoryAt(selected.x, selected.y);
  const r = findRuinAt(selected.x, selected.y);

  actions.hidden = false;
  btnUpg.hidden = !f;
  btnReno.hidden = !r;
  btnInfo.hidden = !(f || r);

  if (f){
    const upgCost = levelUpCost(f);
    btnUpg.disabled = state.money < upgCost;
    btnUpg.textContent = `Fejleszt√©s ‚Üí Lv ${f.level+1} (${fmt(upgCost)})`;
  }
  if (r){
    const need = UNLOCK_GROSS[r.tier];
    const unlocked = r.unlocked;
    const cost = RENO_COST[r.tier];
    btnReno.disabled = !(unlocked && state.money >= cost);
    btnReno.textContent = unlocked ? `Renov√°l√°s (${fmt(cost)})` : `Z√°rolt ‚Äì c√©l: ${fmt(need)} √∂ssz.`;
  }
}

function levelUpCost(f){
  // t√≠pusf√ºgg≈ë √°r: n≈ë a szinttel √©s a t√≠pus index√©vel
  const base = 400 * Math.pow(1.25, f.level-1);
  const typeMul = Math.pow(6, f.type); // k√©s≈ëbbi t√≠pus dr√°g√°bb
  return Math.floor(base * typeMul);
}

btnUpg.onclick = ()=>{
  if (!selected) return;
  const f = findFactoryAt(selected.x, selected.y);
  if (!f) return;
  const cost = levelUpCost(f);
  if (state.money < cost) return;
  state.money -= cost;
  f.level++;
  renderAll(); saveNow(false); toast('Fejlesztve');
};

btnReno.onclick = ()=>{
  if (!selected) return;
  const r = findRuinAt(selected.x, selected.y); if (!r || !r.unlocked) return;
  const cost = RENO_COST[r.tier]; if (state.money < cost) return;
  state.money -= cost;
  // rom -> gy√°r (a tier t√≠pus indexe megegyezik)
  state.city.ruins = state.city.ruins.filter(x=>!(x.x===r.x && x.y===r.y));
  state.city.factories.push({x:r.x,y:r.y,type:r.tier,level:1});
  renderAll(); saveNow(false); toast('Renov√°lva');
};

btnInfo.onclick = ()=>{
  if (!selected) return;
  const f = findFactoryAt(selected.x, selected.y);
  const r = findRuinAt(selected.x, selected.y);
  if (f){
    const conf = TYPES[f.type];
    alert(
      `${conf.name}\n`+
      `Szint: ${f.level}\n`+
      `Termel√©s: ${ipsForFactory(f).toFixed(2)} /s\n`+
      `K√∂vetkez≈ë szint √°ra: ${fmt(levelUpCost(f))}`
    );
  }else if (r){
    const name = TYPES[r.tier].name;
    alert(
      `Rom (${name})\n`+
      `Felold√°s: √∂ssz‚Äëbev√©tel ‚â• ${fmt(UNLOCK_GROSS[r.tier])}\n`+
      `Renov√°l√°s √°ra: ${fmt(RENO_COST[r.tier])}`
    );
  }
};

/* --------- Felold√°s ellen≈ërz√©s --------- */
function checkUnlocks(){
  for (const r of state.city.ruins){
    if (!r.unlocked && state.gross >= UNLOCK_GROSS[r.tier]) {
      r.unlocked = true;
      // vizu√°lis friss√≠t√©s azonnal
      const idx = r.y*CITY_W + r.x; const tile = grid.children[idx];
      if (tile){ const el = tile.querySelector('.ruin'); if (el) el.classList.remove('locked'); }
      toast(`${TYPES[r.tier].name} feloldva ‚Äî renov√°lhat√≥!`);
    }
  }
}

/* --------- R&D (OP tech) --------- */
function techLevel(typeKey, k){ return (state.tech[typeKey]?.[k]||0); }
function techCost(typeKey, k){
  const conf = TYPES.find(t=>t.key===typeKey);
  const t = conf.tech.find(x=>x.k===k);
  const lv = techLevel(typeKey,k);
  return Math.floor(t.base * Math.pow(t.scale, lv));
}
function buyTech(typeKey,k){
  const cost = techCost(typeKey,k);
  if (state.money < cost) return;
  state.money -= cost;
  state.tech[typeKey] = state.tech[typeKey] || {};
  state.tech[typeKey][k] = techLevel(typeKey,k) + 1;
  renderAll(); saveNow(false); toast('Tech fejleszt√©s megv√©ve');
}
function hasAnyFactoryOfType(typeIdx){ return state.city.factories.some(f=>f.type===typeIdx); }
function renderRND(){
  const open = rndPanel.style.display!=='none';
  if (!open) return;
  rndList.innerHTML = '';
  TYPES.forEach((t, idx)=>{
    const enabled = hasAnyFactoryOfType(idx) || state.city.ruins.some(r=>r.tier===idx && r.unlocked);
    if (!enabled) return; // csak ha m√°r tal√°lt√°l bel≈ële vagy feloldottad
    const h = document.createElement('div');
    h.innerHTML = `<h3>${t.name} ‚Äì Tech</h3>`;
    rndList.appendChild(h);
    t.tech.forEach(tech=>{
      const row = document.createElement('div'); row.className='upg-row';
      const lv = techLevel(t.key, tech.k);
      const cost = techCost(t.key, tech.k);
      row.innerHTML = `
        <div>
          <b>${tech.name}</b><br/>
          <small>Szint: ${lv} ‚Ä¢ Szorz√≥: √ó${tech.mult}<span style="opacity:.7">/szint</span></small>
        </div>
        <button class="btn" ${state.money<cost?'disabled':''}>V√©tel (${fmt(cost)})</button>
      `;
      row.querySelector('button').onclick = ()=>buyTech(t.key, tech.k);
      rndList.appendChild(row);
    });
  });
}

/* --------- Ment√©s/Bet√∂lt√©s/Offline --------- */
const SAVE_KEY='infty-city-v2';
function gameGetState(){
  return {
    v:2,
    money:state.money, gross:state.gross, prestige:state.prestige, paused:state.paused,
    city: state.city, tech: state.tech, lastTick: Date.now()
  };
}
function gameSetState(s){
  if (!s) return;
  state.money = Number(s.money)||0;
  state.gross = Number(s.gross)||0;
  state.prestige = Number(s.prestige)||0;
  state.paused = !!s.paused;
  if (s.city){
    state.city.factories = (s.city.factories||[]).map(f=>({x:f.x,y:f.y,type:f.type,level:f.level}));
    state.city.ruins     = (s.city.ruins||[]).map(r=>({x:r.x,y:r.y,tier:r.tier,unlocked:!!r.unlocked}));
  }
  state.tech = s.tech||{};
  renderAll();
}
function gameApplyOffline(ms){
  const gain = totalIPS() * (ms/1000);
  state.money += gain; state.gross += gain;
}
function saveNow(show=true){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify(gameGetState())); if(show) toast('Mentve'); }catch(e){ console.error(e); toast('Ment√©s hiba'); } }
function loadNow(){ try{ const raw=localStorage.getItem(SAVE_KEY); if(!raw){ toast('Nincs ment√©s'); return; } const s=JSON.parse(raw); const dt=Date.now()-(s.lastTick||Date.now()); gameSetState(s); if(dt>5000) gameApplyOffline(dt); toast('Bet√∂ltve'); }catch(e){ console.error(e); toast('Bet√∂lt√©s hiba'); } }
function exportSave(){ try{ const b64=btoa(localStorage.getItem(SAVE_KEY)||''); navigator.clipboard?.writeText(b64); prompt('M√°sold ki a ment√©st:', b64); }catch(e){ toast('Export hiba'); } }
function importSave(){ const b64=prompt('Illeszd be az export√°lt ment√©st:'); if(!b64) return; try{ const raw=atob(b64); localStorage.setItem(SAVE_KEY, raw); loadNow(); }catch(e){ toast('Import hiba'); } }
function resetSave(){ if(!confirm('Biztos? Minden t√∂rl≈ëdik.')) return; localStorage.removeItem(SAVE_KEY); location.reload(); }

/* --------- Loop --------- */
let _last = performance.now();
function loop(){
  const now = performance.now(); const dt = (now-_last)/1000; _last=now;
  if (!state.paused){
    const inc = totalIPS() * dt;
    state.money += inc; state.gross += inc;
    checkUnlocks();
  }
  updateHUD();
  requestAnimationFrame(loop);
}

/* --------- Init --------- */
function init(){
  // ha nincs ment√©s -> seed
  const raw = localStorage.getItem(SAVE_KEY);
  if (raw){
    try{
      const s=JSON.parse(raw);
      gameSetState(s);
      const dt=Date.now()-(s.lastTick||Date.now()); if (dt>5000) gameApplyOffline(dt);
    }catch{ seedCity(); }
  }else{
    seedCity();
  }
  buildGrid();
  updateHUD();
  setInterval(()=>saveNow(false), 10_000);
  requestAnimationFrame(loop);
}

/* --------- Esem√©nyek --------- */
document.getElementById('btn-save').onclick   = ()=>saveNow(true);
document.getElementById('btn-load').onclick   = ()=>loadNow();
document.getElementById('btn-export').onclick = ()=>exportSave();
document.getElementById('btn-import').onclick = ()=>importSave();
document.getElementById('btn-reset').onclick  = ()=>resetSave();
document.getElementById('btn-pause').onclick  = ()=>{ state.paused=!state.paused; toast(state.paused?'Sz√ºnet':'Folytat√°s'); };
document.getElementById('btn-rnd').onclick    = ()=>{
  const show = rndPanel.style.display!=='block';
  rndPanel.style.display = show?'block':'none';
  renderRND();
};

init();
</script>
</body>
</html>
